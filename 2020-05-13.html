<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <title>Kyle Kloberdanz's Blog</title>
        <link rel="stylesheet" type="text/css" href="style/style.css" />
        <link rel="shortcut icon" type="image/svg" href="image/favicon.svg"/>
    </head>

    <body>
        <div class="header">
            <h2>Kyle Kloberdanz's Blog</h2>
            <h4><a href="index.html">Home</a></h4>
        </div>

        <div class="row">
            <div class="leftcolumn">
                <div class="card">
<h2 class="posttitle">Let's build a Lisp interpreter in Rust! (Part 1 - Lexing)</h2>
<h5>13 May 2020</h5>
<img class="img" src="image/sin-small.svg" />

<p>
    Many interpreters rely on external tooling, such as parser generators.
    In this tutorial, we will learn things the hard way by coding everything
    by hand!
</p>

<p>
    But before we get to that, we need to define the basics.
    What is an interpreter?
</p>

<p class="quote">
    An interpreter is a program that reads text, then executes that text as
    a program.
</p>

<p>
    Interpreters are closely related to compilers. A compiler is a program that
    goes a step further. Compilers translate the text from one programming language
    into another language. Commonly, compilers translate the text of a high
    level language, such as Rust, into the machine code that a computer can
    execute. Compilers can have targets other than machine code. Java,
    for example, translates Java code into code that a virtual machine called
    the JVM can execute. TypeScript utilizes a compiler that translates
    TypeScript code into JavaScript, which is then translated into byte code for
    your browser's JavaScript virtual machine (V8 for Chrome, or SpiderMonkey for
    Firefox).
</p>

<p>
    Interpreters and compilers share several things in common. If you build an
    interpreter, you are about half way to having a compiler.
    
</p>
<p>
    Compilers are
    implemented in two major parts, commonly referred to as the front end and
    back end. The front end is responsible for dealing with text, while the
    back end is responsible for generating the output code. Each of these parts
    are composed of smaller parts, which commonly looks something like this.
</p>

<p>
    <div class="indent">Front End</div>
    <ul><ul><ul>
        <li>Lexer</li>
        <li>Parser</li>
    </ul></ul></ul>

    <div class="indent">Back End</div>
    <ul><ul><ul>
        <li>Optimization</li>
        <li>Code Generation</li>
    </ul></ul></ul>
</p>

<h4>
    Lexing
</h4>

<p>
    The lexer or <i>tokenizer</i> is responsible for taking a string of text,
    and converting it into tokens, which are the smallest elements of a program
    that carry some amount of meaning. Tokens in a formal language are the
    equivalent of words in a natural language. Take this sentence for instance.
    <p class="quote">How now brown cow?</p>
    If you ran this sentence through a lexer, you would get the list of words
    <p class="quote">["How", "now", "brown", "cow", "?"]</p>
</p>

<p>
    Let's take a look at this C program below, and see what would happen
    if we tokenized it.
</p>

<div class="codeblock">
<pre>
    <font color="#AF5F00">  1 </font><font color="#4E9A06">int</font> gcd(<font color="#4E9A06">int</font> a, <font color="#4E9A06">int</font> b) {
    <font color="#AF5F00">  2 </font>    <font color="#AF5F00">if</font> (b == <font color="#CC0000">0</font>) {
    <font color="#AF5F00">  3 </font>        <font color="#AF5F00">return</font> a;
    <font color="#AF5F00">  4 </font>    } <font color="#AF5F00">else</font> {
    <font color="#AF5F00">  5 </font>        <font color="#AF5F00">return</font> gcd(b, a % b);
    <font color="#AF5F00">  6 </font>    }
    <font color="#AF5F00">  7 </font>}</pre>
</div>

<p class="quote">
    ["int", "gcd", "(", "int", "a", ",", "int", "b", ")", "{",...]
</p>

<p>
    Let's begin looking at the syntax that we will write a parser for. In this
    tutorial we will be making a Lisp like programming language. Since Lisp 
    (<i><strong>Lis</strong>t <strong>P</strong>rocessor</i>) is also the name
    of a speech impediment... in that spirit, let's call this language
    <i>Stutter</i>!
</p>

<p>
    Here we can see the <a href="https://en.wikipedia.org/wiki/Greatest_common_divisor#Euclid's_algorithm">GCD</a>
    function from before, but now implemented in Stutter.
</p>

<div class="codeblock">
    <pre>
    <font color="#AF5F00">  1 </font><font color="#75507B">(</font>def <font color="#AF5F00">gcd</font>
    <font color="#AF5F00">  2 </font>  <font color="#75507B">(</font><font color="#AF5F00">lambda</font> <font color="#75507B">(</font>a b<font color="#75507B">)</font>
    <font color="#AF5F00">  3 </font>    <font color="#75507B">(</font><font color="#AF5F00">if</font> <font color="#75507B">(</font><font color="#AF5F00">=</font> <font color="#CC0000">0</font> b<font color="#75507B">)</font>
    <font color="#AF5F00">  4 </font>      a
    <font color="#AF5F00">  5 </font>      <font color="#75507B">(</font><font color="#AF5F00">gcd</font> b <font color="#75507B">(</font><font color="#AF5F00">mod</font> a b<font color="#75507B">)))))</font></pre>
</div>

<p>
    First things first, we need to create the project using the cargo program
    that comes bundled with Rust. If you do not have Rust installed already,
    you can get it
    <a href="https://www.rust-lang.org/tools/install">here</a>
</p>

<div class="codeblock">
    <pre>
    $ cargo new stutter --bin
    <font color="#8AE234"><b>     Created</b></font> binary (application) `stutter` package
    </pre>
</div>

<p>
    Since this program won't be very long, for now let's write all the code in
    <i>main.rs</i>
</p>

<p>
    We need to have a way to represent each token within Rust. This is a
    perfect place to use an enum. We'll create an enum called Token that can 
    be used to represent every possible construct within our programming
    language.
</p>

<div class="codeblock">
    <pre>
    <font color="#75507B">#[derive(</font><font color="#4E9A06">Clone</font><font color="#75507B">, </font><font color="#4E9A06">Debug</font><font color="#75507B">, </font><font color="#4E9A06">PartialEq</font><font color="#75507B">)]</font>
    <font color="#AF5F00">enum</font> <font color="#06989A">Token</font> {
        Lparen,      <font color="#3465A4">// (</font>
        Rparen,      <font color="#3465A4">// )</font>
        Plus,        <font color="#3465A4">// +</font>
        Minus,       <font color="#3465A4">// -</font>
        Times,       <font color="#3465A4">// *</font>
        Slash,       <font color="#3465A4">// /</font>
        Percent,     <font color="#3465A4">// %</font>
        Pow,         <font color="#3465A4">// pow</font>
        Gt,          <font color="#3465A4">// &gt;</font>
        Lt,          <font color="#3465A4">// &lt;</font>
        <font color="#4E9A06">Eq</font>,          <font color="#3465A4">// =</font>
        Gte,         <font color="#3465A4">// &gt;=</font>
        Lte,         <font color="#3465A4">// &lt;=</font>
        Let,         <font color="#3465A4">// let</font>
        Def,         <font color="#3465A4">// def</font>
        List,        <font color="#3465A4">// list</font>
        Index,       <font color="#3465A4">// index</font>
        <font color="#4E9A06">Drop</font>,        <font color="#3465A4">// drop</font>
        Quote,       <font color="#3465A4">// quote</font>
        Append,      <font color="#3465A4">// append</font>
        Range,       <font color="#3465A4">// range</font>
        Cat,         <font color="#3465A4">// cat</font>
        Len,         <font color="#3465A4">// len</font>
        Take,        <font color="#3465A4">// take</font>
        If,          <font color="#3465A4">// if</font>
        <font color="#06989A">Int</font>(BigInt), <font color="#3465A4">// Integer literal</font>
        <font color="#06989A">Dec</font>(<font color="#4E9A06">f64</font>),    <font color="#3465A4">// Floating point literal</font>
        <font color="#06989A">Bool</font>(<font color="#4E9A06">bool</font>),  <font color="#3465A4">// Boolean literal</font>
        <font color="#06989A">Id</font>(<font color="#4E9A06">String</font>),  <font color="#3465A4">// identifier (variable name or function name)</font>
    }   
  </pre>
</div>

<p>
    We will want our tokenizer to recognize each symbol that can stand on
    its own. Let's write code that can deduce each symbol.
</p>

<p>
    As a bonus, because Rust allows one to easily plug in additional libraries,
    for our integer type, we can use the
    <a href="https://crates.io/crates/num-bigint">num-bigint</a> to represent
    our integers, so that way they won't be limited to just 64 bits. This crate 
    allows the integers to be arbitrarily large... just as long as they still
    fit into our computer's memory. Our laptop Turing Machines don't yet have
    infinite tape.
</p>

<p>
    Add the following lines to your <i>Cargo.toml</i> file to download the 
    num-bigint dependencies.
</p>

<div class="codeblock">
    <pre>
<font color="#4E9A06">[dependencies]</font>
num-bigint =<font color="#CC0000"> &quot;0.2&quot;</font>
num-traits =<font color="#CC0000"> &quot;0.2&quot;</font>
    </pre>    
</div>

<p>
    And now include them in <i>main.rs</i>
</p>

<div class="codeblock">
    <pre>
<font color="#AF5F00">extern</font> <font color="#AF5F00">crate</font> <font color="#06989A">num_bigint</font>;
<font color="#AF5F00">extern</font> <font color="#AF5F00">crate</font> <font color="#06989A">num_traits</font>;

<font color="#AF5F00">use</font> <font color="#75507B">num_bigint::</font>BigInt</span>;
</pre>
</div>

<p>
    Where were we? Oh yes! Back to the tokenizer! We'll make a function that
    reads in a string, and returns the appropriate kind of token for that
    string.
</p>

<p>
    This code first tries to parse the string as a BigInt. If that fails, it
    then tries to parse it as a 64 bit float. If that fails, it moves on to bool,
    then it will try a list of various reserved words,
    finally culminating in an identifier, after all else fails.
</p>

<p>
    An identifier is something like a function name or a variable name in a
    programming language.
</p>

<div class="codeblock">
<pre>
<font color="#AF5F00">fn</font> <font color="#06989A">to_token</font>(s: <font color="#4E9A06">&amp;String</font>) <font color="#AF5F00">-&gt;</font> Token {
    <font color="#AF5F00">let</font> bytes <font color="#AF5F00">=</font> s.<font color="#06989A">as_bytes</font>();
    <font color="#AF5F00">if</font> <font color="#AF5F00">let</font> <font color="#CC0000">Some</font>(t) <font color="#AF5F00">=</font> <font color="#75507B">BigInt::</font><font color="#06989A">parse_bytes</font>(bytes, <font color="#CC0000">10</font>) {
        <font color="#75507B">Token::</font><font color="#06989A">Int</font>(t)
    } <font color="#AF5F00">else</font> <font color="#AF5F00">if</font> <font color="#AF5F00">let</font> <font color="#CC0000">Ok</font>(t) <font color="#AF5F00">=</font> s.<font color="#06989A">parse</font><font color="#75507B">::</font><font color="#AF5F00">&lt;</font><font color="#4E9A06">f64</font><font color="#AF5F00">&gt;</font>() {
        <font color="#75507B">Token::</font><font color="#06989A">Dec</font>(t)
    } <font color="#AF5F00">else</font> <font color="#AF5F00">if</font> <font color="#AF5F00">let</font> <font color="#CC0000">Ok</font>(t) <font color="#AF5F00">=</font> s.<font color="#06989A">parse</font><font color="#75507B">::</font><font color="#AF5F00">&lt;</font><font color="#4E9A06">bool</font><font color="#AF5F00">&gt;</font>() {
        <font color="#75507B">Token::</font><font color="#06989A">Bool</font>(t)
    } <font color="#AF5F00">else</font> {
        <font color="#AF5F00">match</font> s.<font color="#06989A">as_ref</font>() {
            <font color="#CC0000">&quot;(&quot;</font> <font color="#AF5F00">=&gt;</font> <font color="#75507B">Token::</font>Lparen,
            <font color="#CC0000">&quot;)&quot;</font> <font color="#AF5F00">=&gt;</font> <font color="#75507B">Token::</font>Rparen,
            <font color="#CC0000">&quot;+&quot;</font> <font color="#AF5F00">=&gt;</font> <font color="#75507B">Token::</font>Plus,
            <font color="#CC0000">&quot;-&quot;</font> <font color="#AF5F00">=&gt;</font> <font color="#75507B">Token::</font>Minus,
            <font color="#CC0000">&quot;*&quot;</font> <font color="#AF5F00">=&gt;</font> <font color="#75507B">Token::</font>Times,
            <font color="#CC0000">&quot;/&quot;</font> <font color="#AF5F00">=&gt;</font> <font color="#75507B">Token::</font>Slash,
            <font color="#CC0000">&quot;%&quot;</font> <font color="#AF5F00">=&gt;</font> <font color="#75507B">Token::</font>Percent,
            <font color="#CC0000">&quot;pow&quot;</font> <font color="#AF5F00">=&gt;</font> <font color="#75507B">Token::</font>Pow,
            <font color="#CC0000">&quot;&lt;&quot;</font> <font color="#AF5F00">=&gt;</font> <font color="#75507B">Token::</font>Lt,
            <font color="#CC0000">&quot;&gt;&quot;</font> <font color="#AF5F00">=&gt;</font> <font color="#75507B">Token::</font>Gt,
            <font color="#CC0000">&quot;=&quot;</font> <font color="#AF5F00">=&gt;</font> <font color="#75507B">Token::</font><font color="#4E9A06">Eq</font>,
            <font color="#CC0000">&quot;&gt;=&quot;</font> <font color="#AF5F00">=&gt;</font> <font color="#75507B">Token::</font>Gte,
            <font color="#CC0000">&quot;&lt;=&quot;</font> <font color="#AF5F00">=&gt;</font> <font color="#75507B">Token::</font>Lte,
            <font color="#CC0000">&quot;let&quot;</font> <font color="#AF5F00">=&gt;</font> <font color="#75507B">Token::</font>Let,
            <font color="#CC0000">&quot;def&quot;</font> <font color="#AF5F00">=&gt;</font> <font color="#75507B">Token::</font>Def,
            <font color="#CC0000">&quot;list&quot;</font> <font color="#AF5F00">=&gt;</font> <font color="#75507B">Token::</font>List,
            <font color="#CC0000">&quot;take&quot;</font> <font color="#AF5F00">=&gt;</font> <font color="#75507B">Token::</font>Take,
            <font color="#CC0000">&quot;if&quot;</font> <font color="#AF5F00">=&gt;</font> <font color="#75507B">Token::</font>If,
            <font color="#CC0000">&quot;index&quot;</font> <font color="#AF5F00">=&gt;</font> <font color="#75507B">Token::</font>Index,
            <font color="#CC0000">&quot;drop&quot;</font> <font color="#AF5F00">=&gt;</font> <font color="#75507B">Token::</font><font color="#4E9A06">Drop</font>,
            <font color="#CC0000">&quot;quote&quot;</font> <font color="#AF5F00">=&gt;</font> <font color="#75507B">Token::</font>Quote,
            <font color="#CC0000">&quot;append&quot;</font> <font color="#AF5F00">=&gt;</font> <font color="#75507B">Token::</font>Append,
            <font color="#CC0000">&quot;range&quot;</font> <font color="#AF5F00">=&gt;</font> <font color="#75507B">Token::</font>Range,
            <font color="#CC0000">&quot;cat&quot;</font> <font color="#AF5F00">=&gt;</font> <font color="#75507B">Token::</font>Cat,
            <font color="#CC0000">&quot;len&quot;</font> <font color="#AF5F00">=&gt;</font> <font color="#75507B">Token::</font>Len,
            _ <font color="#AF5F00">=&gt;</font> <font color="#75507B">Token::</font><font color="#06989A">Id</font>(s.<font color="#06989A">to_string</font>()),
        }
    }
}
</pre>
</div>

<p>
    Let's test out this code in main, and give it some example tokens.
</p>

<div class="codeblock">
<pre>
<font color="#AF5F00">fn</font> <font color="#06989A">main</font>() {
    <font color="#75507B">println!</font>(<font color="#CC0000">&quot;{:?}&quot;</font>, <font color="#06989A">to_token</font>(<font color="#4E9A06">&amp;</font><font color="#CC0000">&quot;(&quot;</font>.<font color="#06989A">to_string</font>()));
    <font color="#75507B">println!</font>(<font color="#CC0000">&quot;{:?}&quot;</font>, <font color="#06989A">to_token</font>(<font color="#4E9A06">&amp;</font><font color="#CC0000">&quot;)&quot;</font>.<font color="#06989A">to_string</font>()));
    <font color="#75507B">println!</font>(<font color="#CC0000">&quot;{:?}&quot;</font>, <font color="#06989A">to_token</font>(<font color="#4E9A06">&amp;</font><font color="#CC0000">&quot;def&quot;</font>.<font color="#06989A">to_string</font>()));
    <font color="#75507B">println!</font>(<font color="#CC0000">&quot;{:?}&quot;</font>, <font color="#06989A">to_token</font>(<font color="#4E9A06">&amp;</font><font color="#CC0000">&quot;+&quot;</font>.<font color="#06989A">to_string</font>()));
    <font color="#75507B">println!</font>(<font color="#CC0000">&quot;{:?}&quot;</font>, <font color="#06989A">to_token</font>(<font color="#4E9A06">&amp;</font><font color="#CC0000">&quot;myfunc&quot;</font>.<font color="#06989A">to_string</font>()));
    <font color="#75507B">println!</font>(<font color="#CC0000">&quot;{:?}&quot;</font>, <font color="#06989A">to_token</font>(<font color="#4E9A06">&amp;</font><font color="#CC0000">&quot;myvar&quot;</font>.<font color="#06989A">to_string</font>()));
    <font color="#75507B">println!</font>(<font color="#CC0000">&quot;{:?}&quot;</font>, <font color="#06989A">to_token</font>(<font color="#4E9A06">&amp;</font><font color="#CC0000">&quot;3.14&quot;</font>.<font color="#06989A">to_string</font>()));
    <font color="#75507B">println!</font>(<font color="#CC0000">&quot;{:?}&quot;</font>, <font color="#06989A">to_token</font>(<font color="#4E9A06">&amp;</font><font color="#CC0000">&quot;42&quot;</font>.<font color="#06989A">to_string</font>()));
}
</pre>
</div>

<p>
    When we run it
</p>

<div class="codeblock">
<pre>
$ cargo run
<font color="#8AE234"><b>    Finished</b></font> dev [unoptimized + debuginfo] target(s) in 0.55s
<font color="#8AE234"><b>     Running</b></font> `target/debug/stutter`
Lparen
Rparen
Def
Id("myfunc")
Id("myvar")
Dec(3.14)
Int(BigInt { sign: Plus, data: BigUint { data: [42] } })
</pre>
</div>

<p>
    Looks good! Now we need a function that can take a string and split it into
    individuals tokens.
</p>

<div class="codeblock">
<pre>
<font color="#AF5F00">fn</font> <font color="#06989A">lex</font>(cmd: <font color="#4E9A06">&amp;String</font>) <font color="#AF5F00">-&gt;</font> <font color="#4E9A06">Result</font><font color="#AF5F00">&lt;</font><font color="#4E9A06">Vec</font><font color="#AF5F00">&lt;</font>Token<font color="#AF5F00">&gt;</font>, <font color="#4E9A06">String</font><font color="#AF5F00">&gt;</font> {
    <font color="#AF5F00">let</font> <font color="#4E9A06">mut</font> tokens <font color="#AF5F00">=</font> <font color="#4E9A06">Vec</font><font color="#75507B">::</font><font color="#06989A">new</font>();
    <font color="#AF5F00">let</font> <font color="#4E9A06">mut</font> tok <font color="#AF5F00">=</font> <font color="#4E9A06">String</font><font color="#75507B">::</font><font color="#06989A">new</font>();
    <font color="#AF5F00">let</font> <font color="#4E9A06">mut</font> in_comment <font color="#AF5F00">=</font> <font color="#CC0000">false</font>;
    <font color="#AF5F00">for</font> c <font color="#AF5F00">in</font> cmd.<font color="#06989A">chars</font>() {
        <font color="#AF5F00">if</font> in_comment {
            <font color="#AF5F00">continue</font>;
        }
        <font color="#AF5F00">match</font> c {
            <font color="#CC0000">&apos;;&apos;</font> <font color="#AF5F00">=&gt;</font> in_comment <font color="#AF5F00">=</font> <font color="#CC0000">true</font>,

            <font color="#CC0000">&apos;</font><font color="#75507B">\n</font><font color="#CC0000">&apos;</font> <font color="#AF5F00">=&gt;</font> in_comment <font color="#AF5F00">=</font> <font color="#CC0000">false</font>,

            <font color="#CC0000">&apos;)&apos;</font> <font color="#AF5F00">=&gt;</font> {
                <font color="#AF5F00">if</font> tok.<font color="#06989A">len</font>() <font color="#AF5F00">&gt;</font> <font color="#CC0000">0</font> {
                    tokens.<font color="#06989A">push</font>(<font color="#06989A">to_token</font>(<font color="#4E9A06">&amp;</font>tok));
                    tok <font color="#AF5F00">=</font> <font color="#4E9A06">String</font><font color="#75507B">::</font><font color="#06989A">new</font>();
                }
                tokens.<font color="#06989A">push</font>(<font color="#06989A">to_token</font>(<font color="#4E9A06">&amp;String</font><font color="#75507B">::</font><font color="#06989A">from</font>(<font color="#CC0000">&quot;)&quot;</font>)));
            }

            <font color="#CC0000">&apos;(&apos;</font> <font color="#AF5F00">=&gt;</font> {
                <font color="#AF5F00">if</font> tok.<font color="#06989A">len</font>() <font color="#AF5F00">&gt;</font> <font color="#CC0000">0</font> {
                    tokens.<font color="#06989A">push</font>(<font color="#06989A">to_token</font>(<font color="#4E9A06">&amp;</font>tok));
                    tok <font color="#AF5F00">=</font> <font color="#4E9A06">String</font><font color="#75507B">::</font><font color="#06989A">new</font>();
                }
                tokens.<font color="#06989A">push</font>(<font color="#06989A">to_token</font>(<font color="#4E9A06">&amp;String</font><font color="#75507B">::</font><font color="#06989A">from</font>(<font color="#CC0000">&quot;(&quot;</font>)));
            }

            <font color="#CC0000">&apos; &apos;</font> <font color="#AF5F00">=&gt;</font> {
                <font color="#AF5F00">if</font> tok.<font color="#06989A">len</font>() <font color="#AF5F00">&gt;</font> <font color="#CC0000">0</font> {
                    tokens.<font color="#06989A">push</font>(<font color="#06989A">to_token</font>(<font color="#4E9A06">&amp;</font>tok));
                    tok <font color="#AF5F00">=</font> <font color="#4E9A06">String</font><font color="#75507B">::</font><font color="#06989A">new</font>();
                }
            }

            _ <font color="#AF5F00">=&gt;</font> {
                tok.<font color="#06989A">push</font>(c);
            }
        }
    }

    <font color="#AF5F00">if</font> tok.<font color="#06989A">len</font>() <font color="#AF5F00">&gt;</font> <font color="#CC0000">0</font> {
        <font color="#CC0000">Err</font>(<font color="#75507B">format!</font>(<font color="#CC0000">&quot;Invalid syntax, token not matched: {:?}&quot;</font>, tok))
    } <font color="#AF5F00">else</font> {
        <font color="#CC0000">Ok</font>(tokens)
    }
}
</pre>
</div>

<p>
    Let's test out our tokenizer by changing main to call lex instead
</p>

<div class="codeblock">
<pre>
<font color="#AF5F00">fn</font> <font color="#06989A">main</font>() {
    <font color="#75507B">println!</font>(<font color="#CC0000">&quot;{:#?}&quot;</font>, <font color="#06989A">lex</font>(<font color="#4E9A06">&amp;</font><font color="#CC0000">&quot;(+ 1 2)&quot;</font>.<font color="#06989A">to_string</font>()));
    <font color="#75507B">println!</font>(<font color="#CC0000">&quot;{:#?}&quot;</font>, <font color="#06989A">lex</font>(<font color="#4E9A06">&amp;</font><font color="#CC0000">&quot;(def add (lambda (x y) (+ x y)))&quot;</font>.<font color="#06989A">to_string</font>()));
}</pre>
</div>

<div class="codeblock">
<pre>$ cargo run
<font color="#8AE234"><b>    Finished</b></font> dev [unoptimized + debuginfo] target(s) in 0.04s
<font color="#8AE234"><b>     Running</b></font> `target/debug/stutter`
Ok(
    [
        Lparen,
        Plus,
        Int(
            BigInt {
                sign: Plus,
                data: BigUint {
                    data: [
                        1,
                    ],
                },
            },
        ),
        Int(
            BigInt {
                sign: Plus,
                data: BigUint {
                    data: [
                        2,
                    ],
                },
            },
        ),
        Rparen,
    ],
)
Ok(
    [
        Lparen,
        Def,
        Id(
            &quot;add&quot;,
        ),
        Lparen,
        Id(
            &quot;lambda&quot;,
        ),
        Lparen,
        Id(
            &quot;x&quot;,
        ),
        Id(
            &quot;y&quot;,
        ),
        Rparen,
        Lparen,
        Plus,
        Id(
            &quot;x&quot;,
        ),
        Id(
            &quot;y&quot;,
        ),
        Rparen,
        Rparen,
        Rparen,
    ],
)
</pre>
</div>

<p>
    That looks good. We took a string, and tokenized out a stream of tokens 
    that will be easy to deal with in Rust.
</p>

<p>
    Here's our code so far
</p>

<div class="codeblock">

    <pre><font color="#AF5F00">extern</font> <font color="#AF5F00">crate</font> <font color="#06989A">num_bigint</font>;
<font color="#AF5F00">extern</font> <font color="#AF5F00">crate</font> <font color="#06989A">num_traits</font>;

<font color="#AF5F00">use</font> <font color="#75507B">num_bigint::</font>BigInt;

<font color="#75507B">#[derive(</font><font color="#4E9A06">Clone</font><font color="#75507B">, </font><font color="#4E9A06">Debug</font><font color="#75507B">, </font><font color="#4E9A06">PartialEq</font><font color="#75507B">)]</font>
<font color="#AF5F00">enum</font> <font color="#06989A">Token</font> {
    Lparen,      <font color="#3465A4">// (</font>
    Rparen,      <font color="#3465A4">// )</font>
    Plus,        <font color="#3465A4">// +</font>
    Minus,       <font color="#3465A4">// -</font>
    Times,       <font color="#3465A4">// *</font>
    Slash,       <font color="#3465A4">// /</font>
    Percent,     <font color="#3465A4">// %</font>
    Pow,         <font color="#3465A4">// pow</font>
    Gt,          <font color="#3465A4">// &gt;</font>
    Lt,          <font color="#3465A4">// &lt;</font>
    <font color="#4E9A06">Eq</font>,          <font color="#3465A4">// =</font>
    Gte,         <font color="#3465A4">// &gt;=</font>
    Lte,         <font color="#3465A4">// &lt;=</font>
    Let,         <font color="#3465A4">// let</font>
    Def,         <font color="#3465A4">// def</font>
    List,        <font color="#3465A4">// list</font>
    Index,       <font color="#3465A4">// index</font>
    <font color="#4E9A06">Drop</font>,        <font color="#3465A4">// drop</font>
    Quote,       <font color="#3465A4">// quote</font>
    Append,      <font color="#3465A4">// append</font>
    Range,       <font color="#3465A4">// range</font>
    Cat,         <font color="#3465A4">// cat</font>
    Len,         <font color="#3465A4">// len</font>
    Take,        <font color="#3465A4">// take</font>
    If,          <font color="#3465A4">// if</font>
    <font color="#06989A">Int</font>(BigInt), <font color="#3465A4">// Integer literal</font>
    <font color="#06989A">Dec</font>(<font color="#4E9A06">f64</font>),    <font color="#3465A4">// Floating point literal</font>
    <font color="#06989A">Bool</font>(<font color="#4E9A06">bool</font>),  <font color="#3465A4">// Boolean literal</font>
    <font color="#06989A">Id</font>(<font color="#4E9A06">String</font>),  <font color="#3465A4">// identifier (variable name or function name)</font>
}

<font color="#AF5F00">fn</font> <font color="#06989A">to_token</font>(s: <font color="#4E9A06">&amp;String</font>) <font color="#AF5F00">-&gt;</font> Token {
    <font color="#AF5F00">let</font> bytes <font color="#AF5F00">=</font> s.<font color="#06989A">as_bytes</font>();
    <font color="#AF5F00">if</font> <font color="#AF5F00">let</font> <font color="#CC0000">Some</font>(t) <font color="#AF5F00">=</font> <font color="#75507B">BigInt::</font><font color="#06989A">parse_bytes</font>(bytes, <font color="#CC0000">10</font>) {
        <font color="#75507B">Token::</font><font color="#06989A">Int</font>(t)
    } <font color="#AF5F00">else</font> <font color="#AF5F00">if</font> <font color="#AF5F00">let</font> <font color="#CC0000">Ok</font>(t) <font color="#AF5F00">=</font> s.<font color="#06989A">parse</font><font color="#75507B">::</font><font color="#AF5F00">&lt;</font><font color="#4E9A06">f64</font><font color="#AF5F00">&gt;</font>() {
        <font color="#75507B">Token::</font><font color="#06989A">Dec</font>(t)
    } <font color="#AF5F00">else</font> <font color="#AF5F00">if</font> <font color="#AF5F00">let</font> <font color="#CC0000">Ok</font>(t) <font color="#AF5F00">=</font> s.<font color="#06989A">parse</font><font color="#75507B">::</font><font color="#AF5F00">&lt;</font><font color="#4E9A06">bool</font><font color="#AF5F00">&gt;</font>() {
        <font color="#75507B">Token::</font><font color="#06989A">Bool</font>(t)
    } <font color="#AF5F00">else</font> {
        <font color="#AF5F00">match</font> s.<font color="#06989A">as_ref</font>() {
            <font color="#CC0000">&quot;(&quot;</font> <font color="#AF5F00">=&gt;</font> <font color="#75507B">Token::</font>Lparen,
            <font color="#CC0000">&quot;)&quot;</font> <font color="#AF5F00">=&gt;</font> <font color="#75507B">Token::</font>Rparen,
            <font color="#CC0000">&quot;+&quot;</font> <font color="#AF5F00">=&gt;</font> <font color="#75507B">Token::</font>Plus,
            <font color="#CC0000">&quot;-&quot;</font> <font color="#AF5F00">=&gt;</font> <font color="#75507B">Token::</font>Minus,
            <font color="#CC0000">&quot;*&quot;</font> <font color="#AF5F00">=&gt;</font> <font color="#75507B">Token::</font>Times,
            <font color="#CC0000">&quot;/&quot;</font> <font color="#AF5F00">=&gt;</font> <font color="#75507B">Token::</font>Slash,
            <font color="#CC0000">&quot;%&quot;</font> <font color="#AF5F00">=&gt;</font> <font color="#75507B">Token::</font>Percent,
            <font color="#CC0000">&quot;pow&quot;</font> <font color="#AF5F00">=&gt;</font> <font color="#75507B">Token::</font>Pow,
            <font color="#CC0000">&quot;&lt;&quot;</font> <font color="#AF5F00">=&gt;</font> <font color="#75507B">Token::</font>Lt,
            <font color="#CC0000">&quot;&gt;&quot;</font> <font color="#AF5F00">=&gt;</font> <font color="#75507B">Token::</font>Gt,
            <font color="#CC0000">&quot;=&quot;</font> <font color="#AF5F00">=&gt;</font> <font color="#75507B">Token::</font><font color="#4E9A06">Eq</font>,
            <font color="#CC0000">&quot;&gt;=&quot;</font> <font color="#AF5F00">=&gt;</font> <font color="#75507B">Token::</font>Gte,
            <font color="#CC0000">&quot;&lt;=&quot;</font> <font color="#AF5F00">=&gt;</font> <font color="#75507B">Token::</font>Lte,
            <font color="#CC0000">&quot;let&quot;</font> <font color="#AF5F00">=&gt;</font> <font color="#75507B">Token::</font>Let,
            <font color="#CC0000">&quot;def&quot;</font> <font color="#AF5F00">=&gt;</font> <font color="#75507B">Token::</font>Def,
            <font color="#CC0000">&quot;list&quot;</font> <font color="#AF5F00">=&gt;</font> <font color="#75507B">Token::</font>List,
            <font color="#CC0000">&quot;take&quot;</font> <font color="#AF5F00">=&gt;</font> <font color="#75507B">Token::</font>Take,
            <font color="#CC0000">&quot;if&quot;</font> <font color="#AF5F00">=&gt;</font> <font color="#75507B">Token::</font>If,
            <font color="#CC0000">&quot;index&quot;</font> <font color="#AF5F00">=&gt;</font> <font color="#75507B">Token::</font>Index,
            <font color="#CC0000">&quot;drop&quot;</font> <font color="#AF5F00">=&gt;</font> <font color="#75507B">Token::</font><font color="#4E9A06">Drop</font>,
            <font color="#CC0000">&quot;quote&quot;</font> <font color="#AF5F00">=&gt;</font> <font color="#75507B">Token::</font>Quote,
            <font color="#CC0000">&quot;append&quot;</font> <font color="#AF5F00">=&gt;</font> <font color="#75507B">Token::</font>Append,
            <font color="#CC0000">&quot;range&quot;</font> <font color="#AF5F00">=&gt;</font> <font color="#75507B">Token::</font>Range,
            <font color="#CC0000">&quot;cat&quot;</font> <font color="#AF5F00">=&gt;</font> <font color="#75507B">Token::</font>Cat,
            <font color="#CC0000">&quot;len&quot;</font> <font color="#AF5F00">=&gt;</font> <font color="#75507B">Token::</font>Len,
            _ <font color="#AF5F00">=&gt;</font> <font color="#75507B">Token::</font><font color="#06989A">Id</font>(s.<font color="#06989A">to_string</font>()),
        }
    }
}

<font color="#AF5F00">fn</font> <font color="#06989A">lex</font>(cmd: <font color="#4E9A06">&amp;String</font>) <font color="#AF5F00">-&gt;</font> <font color="#4E9A06">Result</font><font color="#AF5F00">&lt;</font><font color="#4E9A06">Vec</font><font color="#AF5F00">&lt;</font>Token<font color="#AF5F00">&gt;</font>, <font color="#4E9A06">String</font><font color="#AF5F00">&gt;</font> {
    <font color="#AF5F00">let</font> <font color="#4E9A06">mut</font> tokens <font color="#AF5F00">=</font> <font color="#4E9A06">Vec</font><font color="#75507B">::</font><font color="#06989A">new</font>();
    <font color="#AF5F00">let</font> <font color="#4E9A06">mut</font> tok <font color="#AF5F00">=</font> <font color="#4E9A06">String</font><font color="#75507B">::</font><font color="#06989A">new</font>();
    <font color="#AF5F00">let</font> <font color="#4E9A06">mut</font> in_comment <font color="#AF5F00">=</font> <font color="#CC0000">false</font>;
    <font color="#AF5F00">for</font> c <font color="#AF5F00">in</font> cmd.<font color="#06989A">chars</font>() {
        <font color="#AF5F00">if</font> in_comment {
            <font color="#AF5F00">continue</font>;
        }
        <font color="#AF5F00">match</font> c {
            <font color="#CC0000">&apos;;&apos;</font> <font color="#AF5F00">=&gt;</font> in_comment <font color="#AF5F00">=</font> <font color="#CC0000">true</font>,

            <font color="#CC0000">&apos;</font><font color="#75507B">\n</font><font color="#CC0000">&apos;</font> <font color="#AF5F00">=&gt;</font> in_comment <font color="#AF5F00">=</font> <font color="#CC0000">false</font>,

            <font color="#CC0000">&apos;)&apos;</font> <font color="#AF5F00">=&gt;</font> {
                <font color="#AF5F00">if</font> tok.<font color="#06989A">len</font>() <font color="#AF5F00">&gt;</font> <font color="#CC0000">0</font> {
                    tokens.<font color="#06989A">push</font>(<font color="#06989A">to_token</font>(<font color="#4E9A06">&amp;</font>tok));
                    tok <font color="#AF5F00">=</font> <font color="#4E9A06">String</font><font color="#75507B">::</font><font color="#06989A">new</font>();
                }
                tokens.<font color="#06989A">push</font>(<font color="#06989A">to_token</font>(<font color="#4E9A06">&amp;String</font><font color="#75507B">::</font><font color="#06989A">from</font>(<font color="#CC0000">&quot;)&quot;</font>)));
            }

            <font color="#CC0000">&apos;(&apos;</font> <font color="#AF5F00">=&gt;</font> {
                <font color="#AF5F00">if</font> tok.<font color="#06989A">len</font>() <font color="#AF5F00">&gt;</font> <font color="#CC0000">0</font> {
                    tokens.<font color="#06989A">push</font>(<font color="#06989A">to_token</font>(<font color="#4E9A06">&amp;</font>tok));
                    tok <font color="#AF5F00">=</font> <font color="#4E9A06">String</font><font color="#75507B">::</font><font color="#06989A">new</font>();
                }
                tokens.<font color="#06989A">push</font>(<font color="#06989A">to_token</font>(<font color="#4E9A06">&amp;String</font><font color="#75507B">::</font><font color="#06989A">from</font>(<font color="#CC0000">&quot;(&quot;</font>)));
            }

            <font color="#CC0000">&apos; &apos;</font> <font color="#AF5F00">=&gt;</font> {
                <font color="#AF5F00">if</font> tok.<font color="#06989A">len</font>() <font color="#AF5F00">&gt;</font> <font color="#CC0000">0</font> {
                    tokens.<font color="#06989A">push</font>(<font color="#06989A">to_token</font>(<font color="#4E9A06">&amp;</font>tok));
                    tok <font color="#AF5F00">=</font> <font color="#4E9A06">String</font><font color="#75507B">::</font><font color="#06989A">new</font>();
                }
            }

            _ <font color="#AF5F00">=&gt;</font> {
                tok.<font color="#06989A">push</font>(c);
            }
        }
    }

    <font color="#AF5F00">if</font> tok.<font color="#06989A">len</font>() <font color="#AF5F00">&gt;</font> <font color="#CC0000">0</font> {
        <font color="#CC0000">Err</font>(<font color="#75507B">format!</font>(<font color="#CC0000">&quot;Invalid syntax, token not matched: {:?}&quot;</font>, tok))
    } <font color="#AF5F00">else</font> {
        <font color="#CC0000">Ok</font>(tokens)
    }
}

<font color="#AF5F00">fn</font> <font color="#06989A">main</font>() {
    <font color="#75507B">println!</font>(<font color="#CC0000">&quot;{:#?}&quot;</font>, <font color="#06989A">lex</font>(<font color="#4E9A06">&amp;</font><font color="#CC0000">&quot;(+ 1 2)&quot;</font>.<font color="#06989A">to_string</font>()));
    <font color="#75507B">println!</font>(<font color="#CC0000">&quot;{:#?}&quot;</font>, <font color="#06989A">lex</font>(<font color="#4E9A06">&amp;</font><font color="#CC0000">&quot;(def add (lambda (x y) (+ x y)))&quot;</font>.<font color="#06989A">to_string</font>()));
}
</pre>

</div>

<h4>
    Stay tuned for part 2 where I will go through parsing
</h4>
                </div>
            </div>
            <div class="rightcolumn">
                <div class="card">
                    <h2>About</h2>
                    <img class="img" src="image/bw-bike-des-moines-capitol-small.jpg" alt="bicycle, and the Des Moines Capitol Building">
                    <p>
                        This blog is about whatever I find interesting at this
                        very moment. I'll post how-to articles on occasion and
                        various lessons that I've learned in my career.
                    </p>
                </div>
                <div class="card">
                    <h2>Me</h2>
                    <p>
                        I am a software developer from Des Moines Iowa.
                        I graduated from the University of Iowa with a B.S.
                        in Computer Science.
                    </p>
                    <p>
                        I am interested in math, compilers, and
                        interpreters, and I always strive to understand
                        how various systems work from the ground up.
                    </p>
                    <p>
                        The languages I use most often include
                        <ul>
                            <li>C</li>
                            <li>Rust</li>
                            <li>Python</li>
                            <li>C++</li>
                        </ul>
                    </p>
                    <p>
                        I like working in a UNIX or Linux environment.
                    </p>
                </div>
                <div class="card">
                    <h3>Posts</h3>
                    <ul>
<li><a href="2020-10-25.html">[2020-10-25] Convolutions - Where Physics and Machine learning Meet</a></li>
<li><a href="2020-05-14.html">[2020-05-14] A tale of two servers, or why I shudder at the mention of race conditions</a></li>
<li><a href="2020-05-13.html">[2020-05-13] Let's build a Lisp interpreter in Rust! (Part 1 - Lexing)</a></li>
<li><a href="2020-05-10.html">[2020-05-10] OpenMP - Static or Dynamic Scheduling?</a></li>                    </ul>
                </div>
                <div class="card">
                    <h3>Follow Me</h3>
                    <ul>
                        <li>
                            <a href="https://github.com/kkloberdanz">Github</a>
                        </li>
                        <li>
                            <a href="https://www.linkedin.com/in/kyle-kloberdanz-172aaa5a/">linkedin</a>
                        </li>
                    </ul>
                </div>
                <div class="card">
                    <h3>Publications</h3>
                    <ul>
                        <li>
                            <a href="https://conf.researchr.org/details/icse-2022/icse-2022-papers/59/DeepStability-A-Study-of-Unstable-Numerical-Methods-and-Their-Solutions-in-Deep-Lear">[ICSE 2022 Technical Track] DeepStability: A Study of Unstable Numerical Methods and Their Solutions in Deep Learning</a>
                        </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="footer">
            <h3>2022 Kyle Kloberdanz</h3>
        </div>
    </body>
</html>
